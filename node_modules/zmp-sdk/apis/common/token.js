import e from'./../external/@swc/helpers/src/_async_to_generator.mjs.js';import n from'./../external/@swc/helpers/src/_class_call_check.mjs.js';import t from'./../external/@swc/helpers/src/_create_class.mjs.js';import s from'./../external/@swc/helpers/src/_object_spread.mjs.js';import r from"../utils/lodash.js";import{COOKIE_NAME as o,APIS as i,APP_ID as c,ZAPP_ID as a,ApiCallStage as u,MINI_APP_INTERNAL_LINK as l}from"../constants.js";import{logger as m}from"./logger.js";import p from"./call/zaloNative.js";import{apiResponse as f}from"../utils/response.js";import{sendLogData as d}from"./utils.js";import{getDynamicAPIByAction as h}from"../utils/common.js";import g from"./apis/general/authorize.js";import _ from"./apis/general/getSetting.js";import{__generator as T}from'./../external/tslib/tslib.es6.js';import{JumpStatus as k}from"../types/enum.js";var v=function(){function v(){n(this,v),this._jumpStatus=void 0,this.WAITING_QUEUE=[],this.getAccessTokenCount=0,this._accessToken="",this._jsAccessToken="",this.refreshToken="",this._cookies=[],this.accessTokenExpiresIn=0,this.prevGetAccessTokenTimestamp=(new Date).getTime(),this.manualSetAccessToken=!1,this._miniProgramConfig={}}var A=v.prototype;return A.jump=function(){var n=this;return e((function(){return T(this,(function(e){return[2,new Promise((function(e,t){n._jumpStatus?n._jumpStatus===k.DONE?e(k.DONE):e(k.DOING):(n._jumpStatus=k.DOING,m({stage:u.REQUEST,type:"log",name:"jump"}),p("JUMP_LOGIN",{},{success:function(t){var s=t.data;n._miniProgramConfig=(null==s?void 0:s.miniProgramConfig)||{};var r=(null==s?void 0:s.cookiesOAuthLogins)||[],i=r.find((function(e){return e.name===o.JS_TOKEN}));i&&(n._jsAccessToken=i.value,window.ZJSBridge.setJSToken&&window.ZJSBridge.setJSToken(i.value)),n._cookies=r;var c=n._cookies.find((function(e){return e.name===o.ZOAUTH}));(null==c?void 0:c.value)||d([{action:"action.jump.login",error:-102,message:"no zoauth",data:{}}]),e(k.DONE)},fail:function(e){d([{action:"action.jump.login",error:-101,message:e.message||"jump error",data:{}}]),t(e)}},{skipJump:!0}))}))]}))}))()},A.loginZaloV3=function(n,t,s){var r=this;return e((function(){var o;return T(this,(function(c){switch(c.label){case 0:return o="".concat(i.GET_ACCESS_TOKEN_V3,"?app_id=").concat(t,"&redirect_uri=").concat(l,"/").concat(n,"/&code=").concat(s,"&isSDK=true"),[4,fetch(o).then((a=e((function(e){var n,t,s;return T(this,(function(o){switch(o.label){case 0:return[4,e.json()];case 1:return n=o.sent(),t=null==n?void 0:n.access_token,r._accessToken=t,s=1e3*parseInt(n.expires_in),r.accessTokenExpiresIn=s,r.prevGetAccessTokenTimestamp=(new Date).getTime(),window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(r._accessToken||""),[2,t]}}))})),function(e){return a.apply(this,arguments)}))];case 1:return[2,c.sent()]}var a}))}))()},A.loginZaloV4=function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",c=this;return e((function(){var a,u;return T(this,(function(l){switch(l.label){case 0:return(a=new URLSearchParams).append("app_id",n),a.append("code",t),a.append("code_verifier",o),r.isNull(c.refreshToken)||0===c.refreshToken.length?a.append("grant_type","authorization_code"):(a.append("grant_type","refresh_token"),a.append("refresh_token",c.refreshToken||"")),u={headers:{"Content-Type":"application/x-www-form-urlencoded"}},[4,fetch(i.GET_ACCESS_TOKEN,s({method:"POST",body:a},u)).then((m=e((function(e){var n,t,s,r;return T(this,(function(o){switch(o.label){case 0:return[4,e.json()];case 1:return n=o.sent(),t=(null==n?void 0:n.access_token)||"",s=(null==n?void 0:n.refresh_token)||"",c.refreshToken=s,c._accessToken=t,r=1e3*parseInt(null==n?void 0:n.expires_in),c.accessTokenExpiresIn=r,c.prevGetAccessTokenTimestamp=(new Date).getTime(),window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(t),[2,t]}}))})),function(e){return m.apply(this,arguments)}))];case 1:return[2,l.sent()]}var m}))}))()},A.getAccessToken=function(){var n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this;return e((function(){var s,r,i,u,l,m,p,h,g;function _(){return k.apply(this,arguments)}function k(){return(k=e((function(){return T(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){var n=setInterval((function(){(i.getAccessTokenCount<=1||i._accessToken)&&(e("done"),clearInterval(n))}),200)}))];case 1:return[2,e.sent()]}}))}))).apply(this,arguments)}return T(this,(function(e){switch(e.label){case 0:return r=(new Date).getTime()-t.prevGetAccessTokenTimestamp,(i=t).getAccessTokenCount++,t.getAccessTokenCount>1?[4,_()]:[3,2];case 1:e.sent(),e.label=2;case 2:return t.manualSetAccessToken||t._accessToken.length>0&&r<t.accessTokenExpiresIn&&(null===(s=t._miniProgramConfig)||void 0===s?void 0:s.userAuthorized)?(i.getAccessTokenCount--,[2,Promise.resolve(t._accessToken)]):(t.accessToken="",[4,t.jumpAndGetToken(o.ZOAUTH)]);case 3:return u=e.sent(),[4,t.jumpAndGetToken(o.ZOAUTH_VRF)];case 4:return l=e.sent(),m="zmp.getaccesstoken.fail",n?[4,t.verifyUserAuthorized()]:[3,6];case 5:return p=e.sent(),[3,7];case 6:p=!0,e.label=7;case 7:if(!p)throw i.getAccessTokenCount--,d([{action:m,error:-104,message:"no user auth",data:{}}]),f.error.loginFailed("User Authentication Required");if(!u)return[3,15];e.label=8;case 8:return e.trys.push([8,13,,14]),l?[4,t.loginZaloV4(c,u,l)]:[3,10];case 9:return h=e.sent(),[3,12];case 10:return[4,t.loginZaloV3(c,a,u)];case 11:h=e.sent(),e.label=12;case 12:return[3,14];case 13:return g=e.sent(),h="",console.log("Can not get access token",g),d([{action:m,error:-103,message:String(g)||"Can not get access token",data:{}}]),[3,14];case 14:return i.getAccessTokenCount--,h||d([{action:m,error:-101,message:"no accessToken",data:{}}]),[2,Promise.resolve(t._accessToken)];case 15:throw i.getAccessTokenCount--,d([{action:m,error:-102,message:"no oauth",data:{}}]),f.error.loginFailed("Zalo app has not been activated")}}))}))()},A.verifyUserAuthorized=function(){var n=this;return e((function(){var e,t,s,r,o,i;return T(this,(function(c){switch(c.label){case 0:if(t=!0,!1!==(null===(e=n._miniProgramConfig)||void 0===e?void 0:e.userAuthorized))return[3,6];c.label=1;case 1:return c.trys.push([1,5,,6]),(s=h("action.mp.user.authorize"))&&s.isSupported?[4,_()]:[3,4];case 2:return!1!==(null==(o=c.sent())||null===(r=o.authSetting)||void 0===r?void 0:r["scope.userInfo"])?[3,4]:[4,g()];case 3:i=c.sent(),t=(null==i?void 0:i["scope.userInfo"])||!1,c.label=4;case 4:return[3,6];case 5:return c.sent(),t=!1,[3,6];case 6:return[2,t]}}))}))()},A.setAccessToken=function(e){this.manualSetAccessToken=!0,this._accessToken=e,window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(e)},A.getJSAccessToken=function(){var n=this;return e((function(){var e;return T(this,(function(t){switch(t.label){case 0:return n._jsAccessToken.length>0?[2,Promise.resolve(n._jsAccessToken)]:[4,n.jumpAndGetToken(o.JS_TOKEN)];case 1:return e=t.sent(),[2,Promise.resolve(e)]}}))}))()},A.getSync=function(e){var n;return null===(n=this._cookies.find((function(n){return n.name===e})))||void 0===n?void 0:n.value},A.jumpAndGetToken=function(n){var t,s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=this;return new Promise((t=e((function(e){var t,i,c,a;return T(this,(function(u){switch(u.label){case 0:return!s&&o._cookies.length>0?r.isString(n)?(t=o._cookies.find((function(e){return e.name===n})),[2,e(null==t?void 0:t.value)]):[2,e("")]:(s&&o._jumpStatus===k.DONE&&(o._jumpStatus=void 0),i={name:n,cb:function(n){return e(n)}},[4,o.jump()]);case 1:return(c=u.sent())===k.DONE?(o._jumpStatus=c,o.WAITING_QUEUE.length&&(o.WAITING_QUEUE.forEach((function(e){var n=o._cookies.find((function(n){return n.name===e.name}));e.cb(null==n?void 0:n.value)})),o.WAITING_QUEUE=[]),a=o._cookies.find((function(e){return e.name===i.name})),i.cb(null==a?void 0:a.value)):o.WAITING_QUEUE.push(i),[2]}}))})),function(e){return t.apply(this,arguments)}))},v.getInstance=function(){return v.instance||(v.instance=new v),v.instance},t(v,[{key:"jumpStatus",get:function(){return this._jumpStatus}},{key:"accessToken",set:function(e){this._accessToken=e,window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(e)}},{key:"miniProgramConfig",get:function(){return this._miniProgramConfig}}]),v}(),A=v.getInstance();export{A as default};
